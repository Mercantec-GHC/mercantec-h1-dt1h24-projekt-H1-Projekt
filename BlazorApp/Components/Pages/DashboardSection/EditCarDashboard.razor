@using BlazorApp.Service
@inject DBService DbService
@inject UsersService.User user

<label>Enter car to edit</label>
<InputText @bind-Value="carName"/>
<button type="button" onclick="@GetCooper">Get Cooper</button>

@if (fullCooper == null)
{
    <p>Enter car.</p>
}
else
{
    <EditForm Model="@baseCooper" OnValidSubmit="@UpdateCooper">
        <label class="form-label">Model Name:</label>
        <InputText @bind-Value="baseCooper.ModelName" class="form-control"/>

        <label class="form-label">Generation:</label>
        <InputNumber @bind-Value="baseCooper.Generation" class="form-control"/>

        <label class="form-label">Model Type:</label>
        <InputText @bind-Value="baseCooper.ModelType" class="form-control"/>

        <label class="form-label">Color:</label>
        <InputText @bind-Value="baseCooper.Color" class="form-control"/>

        <label class="form-label">Price:</label>
        <InputNumber @bind-Value="baseCooper.Price" class="form-control"/>

        <label class="form-label">Mileage:</label>
        <InputNumber @bind-Value="baseCooper.Mileage" class="form-control"/>

        <label class="form-label">Max range:</label>
        <InputNumber @bind-Value="baseCooper.MaxRange" class="form-control"/>

        <label class="form-label">Weight:</label>
        <InputNumber @bind-Value="baseCooper.Weight" class="form-control"/>

        <label class="form-label">Fuel type:</label>
        <InputText @bind-Value="baseCooper.FuelType" class="form-control"/>

        <label class="form-label">Gear type:</label>
        <InputText @bind-Value="baseCooper.GearType" class="form-control"/>

        <label class="form-label">Yearly tax:</label>
        <InputNumber @bind-Value="baseCooper.YearlyTax" class="form-control"/>
    </EditForm>
    @if (fullCooper.GetEvCooper() != null)
    {
        SetEvCooper();
        <EditForm Model="@evCooper">
            <label class="form-label">Charge Capacity:</label>
            <InputNumber @bind-Value="evCooper.ChargeCapacity" class="form-control"/>

            <label class="form-label">Km. pr. kWh:</label>
            <InputNumber @bind-Value="evCooper.KmPrKwh" class="form-control"/>
        </EditForm>
    }
    else if (fullCooper.GetFossilCooper() != null)
    {
        SetFossilCooper();
        <EditForm Model="@fossilCooper">
            <label class="form-label">Tank Capacity:</label>
            <InputNumber @bind-Value="fossilCooper.TankCapacity" class="form-control"/>

            <label class="form-label">Km. pr. liter:</label>
            <InputNumber @bind-Value="fossilCooper.KmPrLiter" class="form-control"/>

            <label class="form-label">Gears (0 if auto):</label>
            <InputNumber @bind-Value="fossilCooper.Gears" class="form-control"/>
        </EditForm>
    }
    else if (fullCooper.GetHybridCooper() != null)
    {
        SetHybridCooper();
        <EditForm Model="@hybridCooper">
            <label class="form-label">Fuel Type 1:</label>
            <InputText @bind-Value="hybridCooper.FuelType1" class="form-control"/>

            <label class="form-label">Fuel Type 2:</label>
            <InputText @bind-Value="hybridCooper.FuelType2" class="form-control"/>

            <label class="form-label">Tank Capacity:</label>
            <InputNumber @bind-Value="hybridCooper.TankCapacity" class="form-control"/>

            <label class="form-label">Charge Capacity:</label>
            <InputNumber @bind-Value="hybridCooper.ChargeCapacity" class="form-control"/>

            <label class="form-label">Km. pr. liter:</label>
            <InputNumber @bind-Value="hybridCooper.KmPrLiter" class="form-control"/>

            <label class="form-label">Km. pr. kWh:</label>
            <InputNumber @bind-Value="hybridCooper.KmPrKwh" class="form-control"/>

            <label class="form-label">Gears (0 if auto):</label>
            <InputNumber @bind-Value="hybridCooper.Gears" class="form-control"/>
        </EditForm>
    }

    <button type="button" onclick="@UpdateCooper">Opdaterer Cooper</button>
    <button type="button" onclick="@DeleteCooper" class="btn btn-danger">Slet Cooper</button>
}

@code{

    string carName = "";
    MiniCooper.FullMiniCooper? fullCooper;
    MiniCooper.BaseMiniCooper baseCooper = new();

    MiniCooper.EvMiniCooper? evCooper = null;
    MiniCooper.FossilMiniCooper? fossilCooper = null;
    MiniCooper.HybridMiniCooper? hybridCooper = null;

    private async Task GetCooper()
    {
        try
        {
            fullCooper = await DbService.GetFullMiniCooperByUserIdAndName(user.Id, carName);
            await baseCooper.SetBaseMiniCooperModel(fullCooper.GetBaseCooper());
            fullCooper.PrintAutomatically();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error getting cooper to edit: " + ex.Message);
            Console.WriteLine("StackTrace: " + ex.StackTrace);
            throw;
        }
    }

    private async Task UpdateCooper()
    {
        Console.WriteLine("Updating cooper...");
        MiniCooper.FullMiniCooper editedFullCooper = new();
        if (evCooper != null)
        {
            Console.WriteLine("Updating ev...");
            evCooper.SetBaseMiniCooperModel(baseCooper);
            editedFullCooper.SetMiniCooper(evCooper);
        }
        else if (fossilCooper != null)
        {
            Console.WriteLine("Updating fossil...");

            fossilCooper.SetBaseMiniCooperModel(baseCooper);
            editedFullCooper.SetMiniCooper(fossilCooper);
        }
        else if (hybridCooper != null)
        {
            Console.WriteLine("Updating hybrid...");
            hybridCooper.SetBaseMiniCooperModel(baseCooper);
            editedFullCooper.SetMiniCooper(hybridCooper);
        }

        editedFullCooper.PrintAutomatically();
        await DbService.UpdateCooper(editedFullCooper, fullCooper.GetCarId());
        fullCooper.Clear();
        editedFullCooper.Clear();
    }

    private void SetEvCooper()
    {
        evCooper = fullCooper.GetEvCooper();
    }

    private void SetFossilCooper()
    {
        fossilCooper = fullCooper.GetFossilCooper();
    }

    private void SetHybridCooper()
    {
        hybridCooper = fullCooper.GetHybridCooper();
    }

    private async Task DeleteCooper()
    {
        await DbService.DeleteCarByIdAsync(fullCooper.GetCarId());
    }


}